#!/bin/bash

# Configuration
IMAGE_NAME="opencode-runner"
IMAGE_TAG="latest"
FULL_IMAGE_NAME="${IMAGE_NAME}:${IMAGE_TAG}"
EXECUTABLE_NAME="opencode"

# Global variables
EXCLUDE_PATHS=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Prepare persisted home directory files
prepare_home_dir_files() {
    mkdir -p "$HOME/.cache/podman-runner-apps/$IMAGE_NAME"
}

# Function to check if Podman is running
check_podman() {
    if ! podman info >/dev/null 2>&1; then
        print_error "Podman is not running or not accessible"
        exit 1
    fi
}

# Function to check if image exists locally
image_exists() {
    podman images --format "table {{.Repository}}:{{.Tag}}" | grep -q "^${FULL_IMAGE_NAME}$"
}

# Function to build the Podman image
build_image() {
    print_status "Building Podman image: ${FULL_IMAGE_NAME}"
    # Create inline Podmanfile
    cat << 'EOF' | podman build -t "${FULL_IMAGE_NAME}" -
FROM docker.io/oven/bun:1.3.5-alpine AS build
RUN apk add git
WORKDIR /app
RUN git clone --depth=1 https://gitea.i.lhr.ligature.ca/keotl/opencode.git
WORKDIR /app/opencode
RUN bun install
RUN ./packages/opencode/script/build.ts --single

FROM alpine:3.23
RUN apk add libstdc++ libgcc

COPY --from=build /app/opencode/packages/opencode/dist/opencode-linux-x64-musl/bin/opencode /usr/bin/opencode

# Set working directory
WORKDIR /workspace

# Create a non-root user
RUN adduser -D cliuser && \
    chown -R cliuser:cliuser /workspace

# Switch to non-root user
# USER cliuser

# Set default command
CMD ["/bin/bash"]
EOF

    if [ $? -eq 0 ]; then
        print_success "Podman image built successfully"
    else
        print_error "Failed to build Podman image"
        exit 1
    fi
}

# Function to run the container interactively
run_container() {
    print_status "Starting interactive container..."

    # Build exclude volume arguments
    EXCLUDE_VOLUMES=""
    if [ -n "$EXCLUDE_PATHS" ]; then
        IFS=',' read -ra ADDR <<< "$EXCLUDE_PATHS"
        for path in "${ADDR[@]}"; do
            # Trim whitespace
            path=$(echo "$path" | xargs)
            if [ -n "$path" ]; then
                EXCLUDE_VOLUMES="$EXCLUDE_VOLUMES -v /workspace/$(basename $(pwd))/$path"
            fi
        done
    fi

    # Mount current directory to /workspace in container
    # Enable interactive mode with pseudo-TTY
    # Add empty anonymous volumes to hide folders we don't want to expose, e.g. .git/
    podman run --privileged -it --rm \
        -p 6499:6499 \
        -p 4096:4096 \
        -v "$(pwd):/workspace/$(basename $(pwd))" \
        -v "$HOME/.cache/podman-runner-apps/$IMAGE_NAME:/root" \
        -v "/workspace/$(basename $(pwd))/.git" \
        $EXCLUDE_VOLUMES \
        -w /workspace/$(basename $(pwd)) \
        --name "${IMAGE_NAME}-interactive-$(basename $(pwd))" \
        "${FULL_IMAGE_NAME}" \
        "$@"
}

# Main script logic
main() {
    print_status "Podman Interactive CLI Tool Runner"
    echo "=================================="
    
    # Check if Podman is available
    check_podman
    
    # Check if image exists
    if image_exists; then
        print_success "Podman image ${FULL_IMAGE_NAME} found locally"
    else
        print_warning "Podman image ${FULL_IMAGE_NAME} not found locally"
        build_image
    fi
    prepare_home_dir_files
    # Run the container interactively
    run_container "$@"
}

# Help function
show_help() {
    cat << EOF
Usage: $0 [OPTIONS] [COMMAND]

This script runs a CLI tool interactively inside a Podman container.
It will automatically build the image if it doesn't exist locally.

OPTIONS:
    -h, --help                Show this help message
    -r, --rebuild             Force rebuild of the Podman image
    --exclude <paths>         Comma-separated list of directories/files to exclude
                              from the container using anonymous volumes
    --shell                   Bypass EXECUTABLE_NAME and start a /bin/bash shell instead

COMMAND:
    Any command to run inside the container (optional)
    If no command is provided, starts an interactive bash shell

Examples:
    $0                                    # Start interactive bash session
    $0 --rebuild                          # Force rebuild and start interactive session
    $0 --exclude .git,secrets/       # Exclude .git, and secrets/ from container
    $0 --exclude node_modules,dist        # Exclude node_modules and dist directories
    $0 --shell                            # Directly start a bash shell inside the container

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -r|--rebuild)
            print_status "Forcing image rebuild..."
            build_image
            shift
            ;;
        --exclude)
            if [ -z "$2" ]; then
                print_error "--exclude option requires a value"
                exit 1
            fi
            EXCLUDE_PATHS="$2"
            shift 2
            ;;
        --shell)
            SHELL_MODE=1
            shift
            ;;
        *)
            # Pass remaining arguments to the container
            break
            ;;
    esac
done

if [ "$SHELL_MODE" -eq 1 ]; then
    main
else
    # Default behavior: run EXECUTABLE_NAME followed by any user-supplied arguments
    main "$EXECUTABLE_NAME" "$@"
fi
